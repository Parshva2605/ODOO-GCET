// Global variables
let analyticalAccounts = [];
let currentBudgetId = null;

// Check authentication
function checkAuth() {
    const token = localStorage.getItem('token');
    console.log('üîê Checking authentication...');
    console.log('üé´ Token exists:', !!token);
    console.log('üé´ Token length:', token ? token.length : 0);
    
    if (!token) {
        console.log('‚ùå No token found, redirecting to login');
        window.location.href = 'login.html';
        return false;
    }
    
    console.log('‚úÖ Token found, user is authenticated');
    return true;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    if (!checkAuth()) return;
    
    initBudgets();
});

async function initBudgets() {
    await loadAnalyticalAccounts();
    setupTabs();
    setupFormHandler();
    
    // Show Draft Budgets by default (first tab)
    showTab('draft');
}

// Load analytical accounts
async function loadAnalyticalAccounts() {
    const token = localStorage.getItem('token');
    
    console.log('üîÑ Loading analytical accounts...');
    
    try {
        const response = await fetch('/api/analytical-accounts', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        
        console.log('üì° Response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('üì• Raw response:', data);
            
            if (data.success) {
                analyticalAccounts = data.analytical_accounts;
                console.log('‚úÖ Loaded analytical accounts:', analyticalAccounts);
                console.log('üìä Total accounts:', analyticalAccounts.length);
                
                // Show names
                if (analyticalAccounts.length > 0) {
                    analyticalAccounts.forEach(acc => {
                        console.log('  - ' + acc.code + ': ' + acc.name);
                    });
                } else {
                    console.warn('‚ö†Ô∏è No analytical accounts found! Please create some first.');
                }
            } else {
                console.error('‚ùå API error:', data.message);
                analyticalAccounts = [];
            }
        } else {
            console.error('‚ùå Failed to load analytical accounts, status:', response.status);
            analyticalAccounts = [];
        }
    } catch (error) {
        console.error('‚ùå Error loading analytical accounts:', error);
        analyticalAccounts = [];
    }
}

// Setup tabs
function setupTabs() {
    document.querySelectorAll('#budgetTabs .nav-link').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active from all tabs
            document.querySelectorAll('#budgetTabs .nav-link').forEach(t => {
                t.classList.remove('active');
            });
            
            // Add active to clicked tab
            this.classList.add('active');
            
            const tabName = this.getAttribute('data-tab');
            showTab(tabName);
        });
    });
}

// Show tab content
function showTab(tabName) {
    const formView = document.getElementById('budgetForm');
    const listView = document.getElementById('budgetListView');
    
    if (tabName === 'new') {
        // Show form for creating new budget
        formView.style.display = 'block';
        listView.style.display = 'none';
        clearForm();
    } else {
        // Show list view for Draft/Confirmed/Revised/Archived
        formView.style.display = 'none';
        listView.style.display = 'block';
        loadBudgetsByStatus(tabName);
    }
}

// Load budgets by status
async function loadBudgetsByStatus(status) {
    const token = localStorage.getItem('token');
    const tbody = document.getElementById('budgetListBody');
    
    // Show loading
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading budgets...</td></tr>';
    
    try {
        const response = await fetch('/api/budgets', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // Filter budgets by status
                const filteredBudgets = data.budgets.filter(budget => budget.status === status);
                displayBudgetList(filteredBudgets);
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">API Error: ' + data.message + '</td></tr>';
            }
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">HTTP Error: ' + response.status + '</td></tr>';
        }
    } catch (error) {
        console.error('‚ùå Error loading budgets:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Network Error: Check if backend is running on port 5000</td></tr>';
    }
}

// Display budget list
function displayBudgetList(budgets) {
    const tbody = document.getElementById('budgetListBody');
    tbody.innerHTML = '';
    
    if (budgets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No budgets found for this status</td></tr>';
        return;
    }
    
    budgets.forEach(budget => {
        const totalPlanned = budget.total_planned || 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${escapeHtml(budget.name)}</strong></td>
            <td>${formatDate(budget.start_date)}</td>
            <td>${formatDate(budget.end_date)}</td>
            <td><span class="badge bg-${getStatusColor(budget.status)}">${budget.status}</span></td>
            <td>‚Çπ${formatNumber(totalPlanned)}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick="viewBudget(${budget.id})" title="View">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-warning" onclick="editBudget(${budget.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    ${budget.status === 'confirmed' ? '<button class="btn btn-outline-primary" onclick="reviseBudget(' + budget.id + ')" title="Revise"><i class="fas fa-copy"></i></button>' : ''}
                    <button class="btn btn-outline-danger" onclick="deleteBudget(${budget.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Setup form handler
function setupFormHandler() {
    const form = document.getElementById('budgetForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            await saveBudget();
        });
    }
}

// Add budget line
function addBudgetLine(lineData = null) {
    // Check if analytical accounts are loaded
    if (!analyticalAccounts || analyticalAccounts.length === 0) {
        alert('Please wait... Loading analytical accounts. Try again in a moment.');
        console.warn('‚ö†Ô∏è Analytical accounts not loaded yet. Attempting to reload...');
        // Try loading again
        loadAnalyticalAccounts();
        return;
    }
    
    const tbody = document.getElementById('budgetLinesBody');
    const row = document.createElement('tr');
    
    // Build dropdown options
    let options = '<option value="">Select Analytical Account</option>';
    analyticalAccounts.forEach(acc => {
        const selected = lineData && lineData.analytical_account_id === acc.id ? 'selected' : '';
        options += `<option value="${acc.id}" ${selected}>${escapeHtml(acc.code)} - ${escapeHtml(acc.name)}</option>`;
    });
    
    const plannedAmount = lineData ? parseFloat(lineData.planned_amount) : 0;
    const achievedAmount = lineData ? parseFloat(lineData.achieved_amount) : 0;
    const achievedPercentage = plannedAmount > 0 ? (achievedAmount / plannedAmount * 100) : 0;
    const amountToAchieve = Math.max(0, plannedAmount - achievedAmount);
    
    row.innerHTML = `
        <td>
            <select class="form-control form-control-sm line-analytical-account" required>
                ${options}
            </select>
        </td>
        <td>
            <select class="form-control form-control-sm line-type" required>
                <option value="income" ${lineData && lineData.type === 'income' ? 'selected' : ''}>Income</option>
                <option value="expense" ${!lineData || lineData.type === 'expense' ? 'selected' : ''}>Expense</option>
            </select>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm line-planned-amount" 
                   step="0.01" min="0" value="${plannedAmount.toFixed(2)}" required>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" 
                   value="${achievedAmount.toFixed(2)}" readonly>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm" 
                   value="${achievedPercentage.toFixed(1)}%" readonly>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" 
                   value="${amountToAchieve.toFixed(2)}" readonly>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBudgetLine(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    
    console.log('‚úÖ Budget line added. Total analytical accounts: ' + analyticalAccounts.length);
}

window.addBudgetLine = addBudgetLine;

// Remove budget line
function removeBudgetLine(button) {
    if (confirm('Remove this budget line?')) {
        button.closest('tr').remove();
    }
}

window.removeBudgetLine = removeBudgetLine;

// Save budget
async function saveBudget() {
    const token = localStorage.getItem('token');
    const budgetId = document.getElementById('budgetId').value;
    
    // Collect form data
    const budgetData = {
        name: document.getElementById('budgetName').value.trim(),
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        status: document.getElementById('budgetStatus').value,
        lines: []
    };
    
    // Validate required fields
    if (!budgetData.name) {
        alert('Budget name is required');
        return;
    }
    
    if (!budgetData.start_date || !budgetData.end_date) {
        alert('Start date and end date are required');
        return;
    }
    
    // Validate dates
    if (new Date(budgetData.start_date) >= new Date(budgetData.end_date)) {
        alert('End date must be after start date');
        return;
    }
    
    // Collect lines
    const lineRows = document.querySelectorAll('#budgetLinesBody tr');
    lineRows.forEach(row => {
        const analyticalAccountId = parseInt(row.querySelector('.line-analytical-account').value);
        const type = row.querySelector('.line-type').value;
        const plannedAmount = parseFloat(row.querySelector('.line-planned-amount').value);
        
        if (analyticalAccountId && plannedAmount > 0) {
            budgetData.lines.push({
                analytical_account_id: analyticalAccountId,
                type: type,
                planned_amount: plannedAmount
            });
        }
    });
    
    // Validate at least one line
    if (budgetData.lines.length === 0) {
        alert('Please add at least one budget line with a planned amount greater than 0');
        return;
    }
    
    try {
        const url = budgetId ? '/api/budgets/' + budgetId : '/api/budgets';
        const method = budgetId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(budgetData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Budget saved successfully!');
            // Switch to Draft tab to see the saved budget
            document.querySelector('[data-tab="draft"]').click();
        } else {
            alert('Error: ' + (result.message || 'Failed to save budget'));
        }
    } catch (error) {
        console.error('‚ùå Error saving budget:', error);
        alert('Failed to save budget. Check console for details.');
    }
}

// Edit budget
async function editBudget(id) {
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch('/api/budgets/' + id, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                const budget = data.budget;
                
                // Switch to New tab
                document.querySelector('[data-tab="new"]').click();
                
                // Fill form
                document.getElementById('budgetId').value = budget.id;
                document.getElementById('budgetName').value = budget.name;
                document.getElementById('startDate').value = budget.start_date;
                document.getElementById('endDate').value = budget.end_date;
                document.getElementById('budgetStatus').value = budget.status;
                
                // Clear and add lines
                document.getElementById('budgetLinesBody').innerHTML = '';
                if (budget.lines && budget.lines.length > 0) {
                    budget.lines.forEach(line => addBudgetLine(line));
                } else {
                    addBudgetLine(); // Add empty line if no lines exist
                }
            } else {
                alert('Error: ' + data.message);
            }
        } else {
            alert('Failed to load budget');
        }
    } catch (error) {
        console.error('‚ùå Error loading budget:', error);
        alert('Failed to load budget');
    }
}

window.editBudget = editBudget;

// View budget
function viewBudget(id) {
    editBudget(id);
}

window.viewBudget = viewBudget;

// Revise budget
async function reviseBudget(id) {
    if (!confirm('Create a revision of this budget?')) return;
    
    // For now, just edit the budget (revision logic can be added later)
    editBudget(id);
}

window.reviseBudget = reviseBudget;

// Delete budget
async function deleteBudget(id) {
    if (!confirm('Are you sure you want to delete this budget?')) return;
    
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch('/api/budgets/' + id, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Budget deleted successfully!');
            // Reload current tab
            const activeTab = document.querySelector('#budgetTabs .nav-link.active');
            const tabName = activeTab.getAttribute('data-tab');
            showTab(tabName);
        } else {
            alert('Error: ' + (result.message || 'Failed to delete budget'));
        }
    } catch (error) {
        console.error('‚ùå Error deleting budget:', error);
        alert('Failed to delete budget');
    }
}

window.deleteBudget = deleteBudget;

// Clear form
function clearForm() {
    const form = document.getElementById('budgetForm');
    if (form) form.reset();
    
    document.getElementById('budgetId').value = '';
    document.getElementById('budgetLinesBody').innerHTML = '';
    currentBudgetId = null;
    
    // Add one empty line only if analytical accounts are loaded
    if (analyticalAccounts && analyticalAccounts.length > 0) {
        addBudgetLine();
    } else {
        console.log('‚è≥ Waiting for analytical accounts to load before adding line...');
        // Try loading analytical accounts and then add line
        loadAnalyticalAccounts().then(() => {
            if (analyticalAccounts && analyticalAccounts.length > 0) {
                addBudgetLine();
            }
        });
    }
}

// Helper functions
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-IN');
}

function formatNumber(num) {
    return parseFloat(num || 0).toLocaleString('en-IN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function getStatusColor(status) {
    const colors = {
        'draft': 'secondary',
        'confirmed': 'success',
        'revised': 'warning',
        'archived': 'dark'
    };
    return colors[status] || 'secondary';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function cancelBudgetForm() {
    document.querySelector('[data-tab="draft"]').click();
}

window.cancelBudgetForm = cancelBudgetForm;